
import React, {useEffect, useState} from "react";
import toast, { Toaster } from "react-hot-toast";

const API = "http://localhost:8080/api/appointments";

function formatForBackendLocal(dt) {
  if (!dt) return "";
  // dt is either a string from datetime-local input "YYYY-MM-DDTHH:MM"
  if (typeof dt === "string" && dt.length===16) return dt+":00";
  if (dt instanceof Date) {
    const pad=(n)=>n.toString().padStart(2,'0');
    return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}:00`;
  }
  return "";
}

function displayLocal(dtStr) {
  if (!dtStr) return "Invalid Date";
  return dtStr.replace('T',' ').slice(0,16);
}

export default function App(){
  const [appointments, setAppointments] = useState([]);
  const [customer, setCustomer] = useState('');
  const [vehicle, setVehicle] = useState('');
  const [mechanic, setMechanic] = useState('1'); // default mechanic id as string
  const [startInput, setStartInput] = useState('');
  const [endInput, setEndInput] = useState('');

  async function load() {
    try {
      const res = await fetch(API);
      const data = await res.json();
      setAppointments(data);
    } catch(e){
      console.error(e);
    }
  }

  useEffect(()=>{ load() },[]);

  async function book(){
    if(!customer || !vehicle || !mechanic || !startInput || !endInput){
      toast.error("Please fill all fields");
      return;
    }
    const payload = {
      customerName: customer,
      vehicleReg: vehicle,
      mechanicId: Number(mechanic),
      startTime: formatForBackendLocal(startInput),
      endTime: formatForBackendLocal(endInput)
    };
    try{
      const res = await fetch(API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if(res.ok){
        toast.success("Appointment booked");
        setCustomer(''); setVehicle(''); setMechanic('1'); setStartInput(''); setEndInput('');
        load();
      } else {
        const errText = await res.text();
        console.error("Server error:", errText);
        toast.error("Error booking appointment");
      }
    } catch(e){
      console.error(e);
      toast.error("Error booking appointment");
    }
  }

  return (
    <div className="min-h-screen bg-slate-100 flex justify-center py-10 px-4">
      <Toaster />
      <div className="w-full max-w-md bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
        <div className="bg-blue-600 text-white px-6 py-5 flex items-center gap-3 rounded-b-xl">
          <span className="text-2xl">üçÅ</span>
          <h1 className="text-xl font-semibold">Maple Street</h1>
        </div>
        <div className="p-6">
          <h2 className="text-xl font-bold mb-4">Appointment Scheduler</h2>
          <p className="text-sm text-slate-600 mb-6">Fast booking for mechanics ‚Äî avoids double-booking.</p>

          <h3 className="font-semibold mb-3">Book an appointment</h3>

          <div className="space-y-3">
            <input className="w-full border rounded-lg px-3 py-2" placeholder="Customer name" value={customer} onChange={e=>setCustomer(e.target.value)} />
            <input className="w-full border rounded-lg px-3 py-2" placeholder="Vehicle reg" value={vehicle} onChange={e=>setVehicle(e.target.value)} />
            <input className="w-full border rounded-lg px-3 py-2" placeholder="Mechanic id (number)" value={mechanic} onChange={e=>setMechanic(e.target.value)} />

            <div className="flex gap-2">
              <input type="datetime-local" className="w-full border rounded-lg px-3 py-2" value={startInput} onChange={e=>setStartInput(e.target.value)} />
              <input type="datetime-local" className="w-full border rounded-lg px-3 py-2" value={endInput} onChange={e=>setEndInput(e.target.value)} />
            </div>

            <div className="flex gap-2 pt-2">
              <button onClick={book} className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Book appointment</button>
              <button onClick={()=>{ setCustomer(''); setVehicle(''); setMechanic('1'); setStartInput(''); setEndInput(''); }} className="px-4 bg-slate-200 rounded-lg hover:bg-slate-300 transition">Reset</button>
            </div>
          </div>

          <h3 className="font-semibold mt-8 mb-3">Upcoming appointments</h3>
          <div className="space-y-3">
            {appointments.map(a=>(
              <div key={a.id} className="border rounded-xl p-4 bg-slate-50">
                <div className="font-semibold">{a.customerName} ‚Äî {a.vehicleReg}</div>
                <div className="text-sm text-slate-600">Mechanic {a.mechanicId}</div>
                <div className="text-sm text-slate-700 mt-1">{displayLocal(a.startTime)} {" ‚Üí "} {displayLocal(a.endTime)}</div>
                <span className="inline-block mt-2 px-2 py-1 text-xs rounded bg-green-200 text-green-700">{a.status || "SCHEDULED"}</span>
              </div>
            ))}
          </div>

        </div>
      </div>
    </div>
  );
}
